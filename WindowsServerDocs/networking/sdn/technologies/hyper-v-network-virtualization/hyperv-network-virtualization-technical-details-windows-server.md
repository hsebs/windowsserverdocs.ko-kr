---
title: Windows Server 2016의 hyper-v 네트워크 가상화 기술 세부 정보
description: 이 항목에서는 Windows Server 2016의 Hyper-v 네트워크 가상화에 대 한 기술 정보를 제공 합니다.
manager: grcusanz
ms.prod: windows-server
ms.technology: networking-sdn
ms.topic: article
ms.assetid: 9efe0231-94c1-4de7-be8e-becc2af84e69
ms.author: anpaul
author: AnirbanPaul
ms.openlocfilehash: 54fb9eba99a4e6dc565111a3f34c8ccceeca2ff4
ms.sourcegitcommit: b00d7c8968c4adc8f699dbee694afe6ed36bc9de
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 04/08/2020
ms.locfileid: "80859706"
---
# <a name="hyper-v-network-virtualization-technical-details-in-windows-server-2016"></a>Windows Server 2016의 hyper-v 네트워크 가상화 기술 세부 정보

>적용 대상: Windows Server 2016

서버 가상화를 사용하면 단일 실제 호스트에서 동시에 여러 서버 인스턴스를 실행할 수 있지만 서버 인스턴스는 서로 격리됩니다. 각 가상 컴퓨터는 기본적으로 해당 가상 컴퓨터가 실제 컴퓨터에서 실행되는 유일한 서버인 것처럼 작동합니다.  

네트워크 가상화는 동일한 실제 네트워크 인프라에서 여러 가상 네트워크 (잠재적으로 겹치는 IP 주소를 사용할 수 있음)를 실행 하는 유사한 기능을 제공 하며, 각 가상 네트워크는에서 실행 되는 유일한 가상 네트워크 인 것 처럼 작동 합니다. 공유 네트워크 인프라입니다. 그림 1에서는 이 관계를 보여 줍니다.  

![서버 가상화 대 네트워크 가상화](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF1.gif)  

그림 1: 서버 가상화 대 네트워크 가상화  

## <a name="hyper-v-network-virtualization-concepts"></a>Hyper-V 네트워크 가상화 개념  
HNV (Hyper-v 네트워크 가상화)에서 고객 또는 테 넌 트는 기업 또는 데이터 센터에 배포 되는 IP 서브넷 집합의 "소유자"로 정의 됩니다. 고객은 네트워크 격리를 필요로 하는 개인 데이터 센터 또는 서비스 공급자가 호스팅하는 공용 데이터 센터의 테 넌 트에 여러 부서나 사업부를 사용 하는 회사나 enterprise 일 수 있습니다. 각 고객은 데이터 센터에 하나 이상의 [가상 네트워크](#VirtualNetworks) 를 가질 수 있으며, 각 가상 네트워크는 하나 이상의 [가상 서브넷](#VirtualSubnets)으로 구성 됩니다.  

Windows Server 2016: HNVv1 및 HNVv2에서 사용할 수 있는 두 가지 HNV 구현이 있습니다.  

-   **HNVv1**  

    HNVv1는 Windows Server 2012 R2 및 System Center 2012 R2 Virtual Machine Manager (VMM)와 호환 됩니다. HNVv1에 대 한 구성은 WMI 관리 및 Windows PowerShell cmdlet (System Center VMM을 통해)을 사용 하 여 격리 설정 및 CA (고객 주소)를 정의 하 고 PA (가상 네트워크-실제 주소) 매핑 및 라우팅을 정의 합니다. Windows Server 2016에서는 HNVv1에 추가 기능이 추가 되지 않으며 새로운 기능이 계획 되지 않았습니다.  

    *   SET 팀 및 HNV V1은 플랫폼과 호환 되지 않습니다.

    o HA NVGRE 게이트웨이를 사용 하려면 사용자가 LBFO 팀 또는 팀을 사용 해야 합니다. 또는

    o 팀으로 구성 된 스위치를 사용 하 여 네트워크 컨트롤러 배포 게이트웨이를 사용 합니다.


-   **HNVv2**  

    Hyper-v 스위치에서 Azure VFP (가상 필터링 플랫폼) 전달 확장을 사용 하 여 구현 되는 HNVv2에는 많은 새 기능이 포함 되어 있습니다. HNVv2은 SDN (소프트웨어 정의 네트워킹) 스택에 새 네트워크 컨트롤러를 포함 하는 Microsoft Azure Stack와 완전히 통합 됩니다.  가상 네트워크 정책은 NB (RESTful NorthBound) API를 사용 하 여 Microsoft [네트워크 컨트롤러](../../../sdn/technologies/network-controller/Network-Controller.md) 를 통해 정의 되 고 OVSDB를 비롯 한 sbi (Multiple SouthBound Intefaces)를 통해 호스트 에이전트로 배관 됩니다. Hyper-v 스위치가 적용 되는 VFP 확장의 호스트 에이전트 프로그램 정책입니다.  

    > [!IMPORTANT]  
    > 이 항목에서는 HNVv2에 대해 중점적으로 설명 합니다.  

### <a name="virtual-network"></a><a name="VirtualNetworks"></a>가상 네트워크  

-   각 가상 네트워크는 하나 이상의 가상 서브넷으로 구성 됩니다. 가상 네트워크는 가상 네트워크 내의 가상 컴퓨터가 서로 통신할 수 있는 격리 경계를 형성 합니다. 일반적으로이 격리는 분리 된 IP 주소 범위 및 802.1 q 태그 또는 VLAN ID를 사용 하는 Vlan을 사용 하 여 적용 되었습니다. 그러나 HNV를 사용 하는 경우 NVGRE 또는 VXLAN 캡슐화를 사용 하 여 격리를 적용 하 여 고객 또는 테 넌 트 간에 IP 서브넷을 겹칠 가능성이 있는 오버레이 네트워크를 만듭니다.  

-   각 가상 네트워크에는 호스트의 고유한 RDID (라우팅 도메인 ID)가 있습니다. 이 RDID는 대략 네트워크 컨트롤러의 가상 네트워크 REST 리소스를 식별 하기 위해 리소스 ID에 매핑됩니다. 가상 네트워크 REST 리소스는 추가 된 리소스 ID를 사용 하 여 URI (Uniform Resource Identifier) 네임 스페이스를 사용 하 여 참조 됩니다.  

### <a name="virtual-subnets"></a><a name="VirtualSubnets"></a>가상 서브넷  

-   가상 서브넷은 동일한 가상 서브넷 내의 가상 컴퓨터에 대해 계층 3 IP 서브넷 의미 체계를 구현합니다. 가상 서브넷은 VLAN과 유사 하 게 브로드캐스트 도메인을 구성 하 고, NVGRE 테 넌 트 네트워크 ID (TNI) 또는 VXLAN 네트워크 식별자 (VNI) 필드를 사용 하 여 격리를 적용 합니다.  

-   각 가상 서브넷은 단일 가상 네트워크 (RDID)에 속하며, 캡슐화 된 패킷 헤더의 TNI 또는 VNI 키를 사용 하 여 고유한 VSID (가상 서브넷 ID)에 할당 됩니다. VSID은 데이터 센터 내에서 고유 해야 하며 4096 ~ 2 ^ 24-2의 범위에 있습니다.  

가상 네트워크 및 라우팅 도메인의 핵심 이점은 고객이 자신의 네트워크 토폴로지 (예: IP 서브넷)를 클라우드로 가져올 수 있다는 것입니다. 그림 2에서는 Contoso Corp에 별도의 두 네트워크 파란색 연구개발부 넷과 파란색 영업부 넷이 있는 예를 보여 줍니다. 이러한 네트워크는 서로 다른 라우팅 도메인 ID를 가지기 때문에 서로 상호 작용할 수 없습니다. 즉, Contoso Corp가 Contoso R&D Net과 Contoso Sales Net을 둘 다 소유하고 있더라도 이러한 두 네트워크는 서로 격리되어 있습니다. Contoso R&D Net에는 세 개의 가상 서브넷이 포함되어 있습니다. RDID와 VSID는 둘 다 데이터 센터 내에서 고유합니다.  

![고객 네트워크 및 가상 서브넷](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF6.gif)  

그림 2: 고객 네트워크 및 가상 서브넷  

**계층 2 전달**  

그림 2에서 VSID 5001의 가상 머신은 Hyper-v 스위치를 통해 VSID 5001에 있는 가상 머신에 전달 된 패킷을 가질 수 있습니다. VSID 5001의 가상 컴퓨터에서 들어오는 패킷은 Hyper-v 스위치의 특정 VPort에 전송 됩니다. 수신 규칙 (예: encap) 및 매핑 (예: 캡슐화 헤더)은 이러한 패킷에 대 한 Hyper-v 스위치에 의해 적용 됩니다. 그러면 패킷이 Hyper-v 스위치의 다른 VPort (대상 가상 머신이 동일한 호스트에 연결 된 경우) 또는 다른 호스트의 다른 Hyper-v 스위치 (대상 가상 머신이 다른 호스트에 있는 경우)로 전달 됩니다.  

**계층 3 라우팅**  

마찬가지로, VSID 5001의 가상 컴퓨터에는 각 Hyper-v 호스트의 VSwitch에 있는 HNV 분산 라우터가 VSID 5002 또는 VSID 5003의 가상 컴퓨터로 라우팅되는 패킷이 있을 수 있습니다. Hyper-v 스위치에 패킷을 전달 하면 HNV는 들어오는 패킷의 VSID를 대상 가상 머신의 VSID 업데이트 합니다. 이러한 상황은 두 VSID가 동일한 RDID에 있는 경우에만 발생합니다.  따라서 패킷을 보낼를 사용 하는 가상 네트워크 어댑터는 게이트웨이를 트래버스 하지 않고 RDID2를 사용 하 여 가상 네트워크 어댑터에 패킷을 전송할 수 없습니다.  

> [!NOTE]  
> 위의 패킷 흐름 설명에서 "가상 컴퓨터" 라는 용어는 실제로 가상 컴퓨터의 가상 네트워크 어댑터를 의미 합니다. 일반적인 경우는 가상 컴퓨터에 가상 네트워크 어댑터가 하나뿐인 경우입니다. 이 경우 "가상 머신" 및 "가상 네트워크 어댑터" 라는 단어는 개념적으로 동일한 것을 의미할 수 있습니다.  

각 가상 서브넷은 VLAN과 유사한 계층 3 IP 서브넷 및 L2(계층 2) 브로드캐스트 도메인 경계를 정의합니다. 가상 컴퓨터에서 패킷을 브로드캐스트하는 경우 HNV는 UR (유니캐스트 복제)를 사용 하 여 원래 패킷의 복사본을 만들고 대상 IP 및 MAC을 동일한 VSID에 있는 각 VM의 주소로 바꿉니다.  

> [!NOTE]  
> Windows Server 2016이 제공 되 면 브로드캐스트 및 서브넷 멀티 캐스트가 유니캐스트 복제를 사용 하 여 구현 됩니다. 서브넷 간 멀티 캐스트 라우팅과 IGMP는 지원 되지 않습니다.  

브로드캐스트 도메인인 것 외에 VSID는 격리를 제공합니다. HNV의 가상 네트워크 어댑터는 ACL 규칙이 적용 되는 Hyper-v 스위치 포트에 연결 됩니다 .이 포트는 해당 포트 (virtualNetworkInterface REST 리소스) 또는 해당 구성 요소를 구성 하는 VSID (가상 서브넷)에 직접 적용 됩니다.  

Hyper-v 스위치 포트에는 ACL 규칙이 적용 되어 있어야 합니다. 5 개 튜플 (원본 IP, 대상 IP, 원본 포트, 대상 포트, 프로토콜)을 기반으로 하는 특정 유형의 트래픽만 허용 하도록이 ACL은 모두 허용, 모두 거부 또는 보다 구체적으로 지정할 수 있습니다.  

> [!NOTE]  
> Hyper-v 스위치 확장은 새 SDN (소프트웨어 정의 네트워킹) 스택의 HNVv2에서 작동 하지 않습니다. HNVv2는 다른 타사 스위치 확장과 함께 사용할 수 없는 Azure VFP (가상 필터링 플랫폼) 스위치 확장을 사용 하 여 구현 됩니다.  

## <a name="switching-and-routing-in-hyper-v-network-virtualization"></a>Hyper-v 네트워크 가상화에서 전환 및 라우팅  
HNVv2는 실제 스위치 또는 라우터를 작동 하는 것 처럼 작동 하도록 올바른 L2 (계층 2) 전환 및 계층 3 (L3) 라우팅 의미 체계를 구현 합니다. HNV 가상 네트워크에 연결 된 가상 머신이 동일한 가상 서브넷 (VSID)에 있는 다른 가상 머신과의 연결을 설정 하려고 시도 하는 경우 먼저 원격 가상 머신의 CA MAC 주소를 알아야 합니다. 원본 가상 컴퓨터의 ARP 테이블에 대상 가상 컴퓨터의 IP 주소에 대 한 ARP 항목이 있는 경우이 항목의 MAC 주소가 사용 됩니다. 항목이 없는 경우 원본 가상 컴퓨터는 반환할 대상 가상 컴퓨터의 IP 주소에 해당 하는 MAC 주소에 대 한 요청과 함께 ARP 브로드캐스트를 보냅니다. Hyper-v 스위치는이 요청을 가로채서 호스트 에이전트로 보냅니다. 호스트 에이전트는 로컬 데이터베이스에서 요청 된 대상 가상 컴퓨터의 IP 주소에 해당 하는 MAC 주소를 확인 합니다.  

> [!NOTE]  
> OVSDB 서버 역할을 하는 호스트 에이전트는 VTEP 스키마의 변형을 사용 하 여 CA PA 매핑, MAC 테이블 등을 저장 합니다.  

MAC 주소를 사용할 수 있는 경우 호스트 에이전트는 ARP 응답을 삽입 하 고이를 다시 가상 머신으로 보냅니다. 가상 컴퓨터의 네트워킹 스택에 필요한 L2 헤더 정보가 모두 있으면 해당 프레임은 V 스위치의 해당 Hyper-v 포트로 전송 됩니다. 내부적으로 Hyper-v 스위치는 V 포트에 할당 된 N 튜플 일치 규칙에 대해이 프레임을 테스트 하 고 이러한 규칙에 따라 프레임에 특정 변환을 적용 합니다. 가장 중요 한 것은 네트워크 컨트롤러에서 정의 된 정책에 따라 NVGRE 또는 VXLAN를 사용 하 여 캡슐화 헤더를 생성 하기 위해 캡슐화 변환 집합을 적용 하는 것입니다. 호스트 에이전트에서 프로그래밍 한 정책에 따라, CA PA 매핑은 대상 가상 머신이 있는 Hyper-v 호스트의 IP 주소를 확인 하는 데 사용 됩니다. Hyper-v 스위치는 원격 PA 주소에 도달할 수 있도록 올바른 라우팅 규칙과 VLAN 태그가 외부 패킷에 적용 되도록 합니다.  

HNV 가상 네트워크에 연결 된 가상 머신이 다른 가상 서브넷 (VSID)에 있는 가상 머신과의 연결을 만들려고 하는 경우이에 따라 패킷을 라우트 해야 합니다. HNV는 모든 IP 접두사 (즉, 하나의 기본 경로/게이트웨이)에 도달 하는 데 사용 되는 다음 홉으로 사용 되는 CA 공간에서 IP 주소가 하나 뿐 인 별모양 토폴로지를 가정 합니다. 현재는 단일 기본 경로에 대 한 제한이 적용 되며 기본 경로가 아닌 경로는 지원 되지 않습니다.  

### <a name="routing-between-virtual-subnets"></a>가상 서브넷 간의 라우팅  
실제 네트워크에서 IP 서브넷은 컴퓨터 (가상 및 실제)가 서로 직접 통신할 수 있는 L2 (계층 2) 도메인입니다. L2 도메인은 arp 항목 (IP: MAC 주소 맵)이 모든 인터페이스에서 브로드캐스팅하는 ARP 요청을 통해 학습 되 고, ARP 응답이 요청 호스트로 다시 전송 되는 브로드캐스트 도메인입니다. 컴퓨터는 ARP 응답에서 배운 MAC 정보를 사용 하 여 이더넷 헤더를 포함 한 L2 프레임을 완전히 구성 합니다. 그러나 IP 주소가 다른 L3 서브넷에 있는 경우 ARP 요청은이 L3 경계를 넘지 않습니다. 대신, 원본 서브넷에서 IP 주소가 있는 L3 라우터 인터페이스 (다음 홉 또는 기본 게이트웨이)는 자체 MAC 주소를 사용 하 여 이러한 ARP 요청에 응답 해야 합니다.  

표준 Windows 네트워킹에서 관리자는 고정 경로를 만들어 네트워크 인터페이스에 할당할 수 있습니다. 또한 일반적으로 "기본 게이트웨이"는 기본 경로 (0.0.0.0/0)를 대상으로 하는 패킷이 전송 되는 인터페이스의 다음 홉 IP 주소로 구성 됩니다. 특정 경로가 없는 경우 패킷이이 기본 게이트웨이로 전송 됩니다. 이는 일반적으로 실제 네트워크에 사용되는 라우터입니다.  HNV는 모든 호스트의 일부인 기본 제공 라우터를 사용 하 고 가상 네트워크에 대 한 분산 라우터를 만들기 위해 모든 VSID에 인터페이스를 포함 합니다.  

HNV는 별모양 토폴로지를 가정 하므로 HNV 분산 라우터는 동일한 VSID 네트워크의 일부인 가상 서브넷 간에 이동 하는 모든 트래픽에 대해 단일 기본 게이트웨이의 역할을 합니다. 기본 게이트웨이로 사용 되는 주소는 VSID에서 가장 낮은 IP 주소를 기본값으로 사용 하 고 HNV 분산 라우터에 할당 됩니다. 이 분산 라우터를 사용 하면 각 호스트에서 중개 없이 적절 한 호스트로 트래픽을 직접 라우팅할 수 있기 때문에 VSID 네트워크 내의 모든 트래픽을 적절히 라우팅할 수 있습니다.  이는 동일한 VM 네트워크에 있지만 가상 서브넷이 서로 다른 두 개의 가상 컴퓨터가 동일한 실제 호스트에 있는 경우에 특히 유용합니다.  이 섹션의 뒷부분에 설명되어 있는 것처럼, 패킷이 실제 호스트에서 나갈 필요가 없습니다.  

### <a name="routing-between-pa-subnets"></a>PA 서브넷 간의 라우팅  
각 가상 서브넷 (VSID)에 하나의 PA IP 주소를 할당 하는 HNVv1와 달리 이제 HNVv2는 스위치 포함 팀 (SET) NIC 팀 구성원 당 PA IP 주소 하나를 사용 합니다. 기본 배포에서는 두 NIC 팀을 가정 하 고 호스트 당 PA IP 주소를 2 개 할당 합니다. 단일 호스트는 동일한 VLAN의 PA (동일한 공급자) 논리 서브넷에서 PA Ip를 할당 합니다. 동일한 가상 서브넷에 있는 두 개의 테 넌 트 Vm은 서로 다른 두 개의 공급자 논리 서브넷에 연결 된 서로 다른 두 호스트에 있을 수 있습니다. HNV는 CA PA 매핑을 기반으로 캡슐화 된 패킷에 대 한 외부 IP 헤더를 생성 합니다. 그러나 기본 PA 게이트웨이의 ARP에 호스트 TCP/IP 스택을 사용 하 고 ARP 응답에 따라 외부 이더넷 헤더를 작성 합니다. 일반적으로이 ARP 응답은 호스트가 연결 된 실제 스위치 또는 L3 라우터의 SVI 인터페이스에서 제공 됩니다. 따라서 HNV는 공급자 논리 서브넷/v m 간에 캡슐화 된 패킷을 라우팅하는 데 L3 라우터를 사용 합니다.  

### <a name="routing-outside-a-virtual-network"></a>가상 네트워크 외부 라우팅  
대부분의 고객 배포에는 HNV 환경에서 HNV 환경에 속하지 않는 리소스로의 통신이 필요합니다. 두 환경 간의 통신을 허용하기 위해서는 네트워크 가상화 게이트웨이가 필요합니다. HNV 게이트웨이가 필요한 인프라에는 사설 클라우드 및 하이브리드 클라우드가 포함 됩니다. 기본적으로 HNV 게이트웨이는 IPSec VPN 또는 GRE 터널을 사용 하는 다른 사이트 및/또는 클라우드 (개인 또는 공용) 간의 계층 3 라우팅에 필요 합니다.  

게이트웨이는 다양한 실제 폼 팩터로 제공될 수 있습니다. Windows Server 2016을 기반으로 하 고, 부하 분산 장치에서 알린 VIP (가상 IP)를 통해 액세스 하 고, 다른 기존 네트워크 어플라이언스에 배치 하거나, 새로운 독립 실행형 네트워크 어플라이언스 일 수 있습니다. .  

Windows RAS 게이트웨이 옵션에 대 한 자세한 내용은 [Ras gateway](../../../../remote/remote-access/ras-gateway/RAS-Gateway.md)를 참조 하세요.  

## <a name="packet-encapsulation"></a>패킷 캡슐화  
HNV의 각 가상 네트워크 어댑터는 다음의 두 IP 주소와 연관되어 있습니다.  

-   CA ( **고객 주소** )는 인트라넷 인프라를 기반으로 고객이 할당 한 IP 주소입니다. 이 주소를 통해 고객은 공용 또는 사설 클라우드로 이동 하지 않은 것 처럼 가상 머신과 네트워크 트래픽을 교환할 수 있습니다. CA는 가상 컴퓨터에 표시되며 고객은 CA에 접근할 수 있습니다.  

-   PA ( **공급자 주소** )는 해당 실제 네트워크 인프라를 기반으로 하 여 호스팅 공급자 또는 데이터 센터 관리자가 할당 한 IP 주소입니다. PA는 네트워크에서 가상 컴퓨터를 호스팅하는 Hyper-V 실행 서버와 교환되는 패킷에 나타납니다. PA는 실제 네트워크에 표시되지만 가상 컴퓨터에는 표시되지 않습니다.  

CA는 PA에 의해 구현된 대로 고객의 네트워크 토폴로지(가상화되었으며 실제 기본 실제 네트워크 토폴로지 및 주소에서 분리됨)를 유지 관리합니다. 다음 다이어그램은 네트워크 가상화 결과로 생성된, 가상 컴퓨터 CA와 네트워크 인프라 PA 간의 개념적 관계를 보여 줍니다.  

![실제 인프라에서 네트워크 가상화의 개념적 다이어그램](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF2.gif)  

그림 6: 실제 인프라에서 네트워크 가상화의 개념적 다이어그램  

다이어그램에서 고객 가상 머신은 CA 공간에서 데이터 패킷을 보내고 있으며,이는 자체 가상 네트워크 또는 "터널"을 통해 실제 네트워크 인프라를 통과 합니다. 위의 예에서 터널은 왼쪽의 원본 호스트에서 오른쪽의 대상 호스트로 전달 되는 녹색 배송 레이블 (PA 주소)이 있는 Contoso 및 Fabrikam 데이터 패킷을 둘러싼 "봉투 (envelope)"로 간주할 수 있습니다. 키는 호스트가 Contoso와 Fabrikam CA에 해당 하는 "배달 주소" (PA)를 결정 하는 방법, "envelope"이 패킷 주위에 배치 되는 방법 및 대상 호스트가 패킷을 래핑 해제 하 여 Contoso 및 Fabrikam에 전달 하는 방법입니다. 대상 가상 컴퓨터를 올바르게 합니다.  

이 간단한 비유는 네트워크 가상화의 핵심적인 면을 잘 나타내 줍니다.  

-   각 가상 컴퓨터 CA는 실제 호스트 PA에 매핑됩니다. 여러 CA를 동일한 PA에 연결할 수 있습니다.  

-   가상 컴퓨터는 CA 공간에서 데이터 패킷을 보내고,이는 매핑을 기반으로 PA 원본 및 대상 쌍을 사용 하 여 "봉투"에 배치 됩니다.  

-   CA-PA 매핑은 호스트가 서로 다른 고객 가상 컴퓨터에 대한 패킷을 구분할 수 있도록 해야 합니다.  

따라서 네트워크를 가상화하는 메커니즘은 가상 컴퓨터에 사용되는 네트워크 주소를 가상화하는 것입니다. 네트워크 컨트롤러는 주소 매핑을 담당 하며, 호스트 에이전트는 MS_VTEP 스키마를 사용 하 여 매핑 데이터베이스를 유지 관리 합니다. 다음 섹션에서는 주소 가상화의 실제 메커니즘에 대해 설명합니다.  

## <a name="network-virtualization-through-address-virtualization"></a>주소 가상화를 통한 네트워크 가상화  
HNV는 네트워크 가상화 NVGRE (제네릭 라우팅 캡슐화) 또는 VXLAN (가상 확장 가능 로컬 영역 네트워크)를 사용 하 여 오버레이 테 넌 트 네트워크를 구현 합니다.  VXLAN가 기본값입니다.  

### <a name="virtual-extensible-local-area-network-vxlan"></a>VXLAN (Virtual eXtensible Local Area Network)  
Virtual eXtensible Local Area Network (VXLAN) ([RFC 7348](https://www.rfc-editor.org/info/rfc7348)) 프로토콜은 Cisco, Brocade, Arista, DELL, HP 등과 같은 공급 업체의 지원을 통해 시장 환경에서 널리 채택 되 고 있습니다. VXLAN 프로토콜은 전송으로 UDP를 사용 합니다. VXLAN에 대 한 IANA에서 할당 된 UDP 대상 포트는 4789이 고, UDP 원본 포트는 ECMP 확산에 사용 되는 내부 패킷의 정보 해시 여야 합니다. UDP 헤더 뒤에는 VXLAN 헤더가 추가 됩니다. 여기에는 예약 된 4 바이트 필드와 VXLAN 네트워크 식별자 (VNI)-VSID에 대 한 3 바이트 필드, 또 다른 예약 된 1 바이트 필드가 차례로 추가 됩니다. VXLAN 헤더 뒤에는 CA 이더넷 프레임 FCS 없이 원래 CA L2 프레임이 추가 됩니다.  

![VXLAN packet 헤더](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VXLAN-packet-header.png)  

### <a name="generic-routing-encapsulation-nvgre"></a>NVGRE (제네릭 라우팅 캡슐화)  
이 네트워크 가상화 메커니즘은 터널 헤더의 일부로 NVGRE (제네릭 라우팅 캡슐화)를 사용 합니다. NVGRE에서 가상 컴퓨터의 패킷은 다른 패킷 내에 캡슐화 됩니다. 이 새 패킷의 헤더에는 그림 7에 표시된 것처럼 GRE 헤더의 키 필드에 저장된 가상 서브넷 ID 외에 적절한 원본 및 대상 PA IP 주소가 포함되어 있습니다.  

![NVGRE 캡슐화](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF3.gif)  

그림 7: 네트워크 가상화 - NVGRE 캡슐화  

가상 서브넷 ID를 통해 호스트는 패킷의 PA와 CA가 겹칠 수 있는 경우에도 지정 된 패킷에 대 한 고객 가상 머신을 식별할 수 있습니다. 이를 통해 그림 7에 표시된 것처럼 동일한 호스트의 모든 가상 컴퓨터가 단일 PA를 공유할 수 있습니다.  

PA 공유는 네트워크 확장성에 큰 영향을 줍니다. 네트워크 인프라에서 알아야 하는 IP 및 MAC 주소 수를 상당히 줄일 수 있습니다. 예를 들어, 모든 최종 호스트에 평균 30대의 가상 컴퓨터가 있는 경우 네트워크 인프라에서 알아야 하는 IP 및 MAC 주소 수는 인수 30으로 줄어듭니다. 또한 패킷에 포함된 가상 서브넷 ID를 통해 쉽게 실제 고객과 패킷 간의 상관 관계를 알 수 있습니다.  

Windows Server 2012 r 2의 PA 공유 체계는 호스트 당 VSID 당 1 PA입니다. Windows Server 2016의 경우 구성표는 NIC 팀 구성원 당 하나의 PA입니다.  

Windows Server 2016 이상에서 HNV는 기본적으로 NVGRE 및 VXLAN를 완전히 지원 합니다. Nic (네트워크 어댑터), 스위치 또는 라우터와 같은 새 네트워크 하드웨어를 업그레이드 하거나 구매할 필요가 없습니다. 이는 네트워크에서 이러한 패킷이 PA 공간에서 오늘날의 네트워크 인프라와 호환 되는 일반 IP 패킷이 기 때문입니다.  그러나 최상의 성능을 얻으려면 작업 오프 로드를 지 원하는 최신 드라이버를 사용 하 여 지원 되는 Nic를 사용 하십시오.  

## <a name="multi-tenant-deployment-example"></a>다중 테넌트 배포 예  
다음 다이어그램에서는 네트워크 정책에 정의 된 CA PA 관계를 사용 하 여 클라우드 데이터 센터에 있는 두 고객의 배포 예를 보여 줍니다.  

![다중 테넌트 배포 예](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF5.png)  

그림 8: 다중 테넌트 배포 예  

그림 8의 예를 살펴보십시오. 호스팅 공급자의 공유 IaaS 서비스로 이동하기 전:  

-   Contoso Corp는 IP 주소 10.1.1.11에서 SQL Server(이름: **SQL**)를 실행하고, IP 주소 10.1.1.12에서 웹 서버(이름: **Web**)를 실행합니다. 이 주소에서는 데이터베이스 트랜잭션에 해당 SQL Server를 사용합니다.  

-   Fabrikam Corp는 SQL Server(이름: **SQL** )를 실행하고 IP 주소 10.1.1.11을 할당했으며, IP 주소 10.1.1.12에서 웹 서버(이름: **Web** )를 실행하고 데이터베이스 트랜잭션에 해당 SQL Server를 사용합니다.  

이전에는 호스팅 서비스 공급자가 네트워크 컨트롤러를 통해 해당 실제 네트워크 토폴로지에 해당 하는 공급자 (PA) 논리 네트워크를 만든 것으로 가정 합니다. 네트워크 컨트롤러는 호스트가 연결 된 논리 서브넷의 IP 접두사에서 두 개의 PA IP 주소를 할당 합니다. 또한 네트워크 컨트롤러는 IP 주소를 적용 하는 데 적절 한 VLAN 태그를 나타냅니다.  

네트워크 컨트롤러, Contoso Corp 및 Fabrikam Corp를 사용 하 여 호스팅 서비스 공급자가 지정한 공급자 (PA) 논리 네트워크에서 지원 되는 가상 네트워크 및 서브넷을 만듭니다. Contoso Corp와 Fabrikam Corp는 각각 해당 SQL Server 및 웹 서버를 동일한 호스팅 공급자의 공유 IaaS 서비스로 이동하고 동시에 Hyper-V 호스트 1에서 **SQL** 가상 컴퓨터를 실행하고 Hyper-V 호스트 2에서 **Web** (IIS7) 가상 컴퓨터를 실행합니다. 모든 가상 컴퓨터는 원래 인트라넷 IP 주소(해당 CA)를 유지합니다.  

두 회사 모두 아래와 같이 네트워크 컨트롤러에서 다음 VSID (가상 서브넷 ID)를 할당 받습니다.  각 Hyper-v 호스트의 호스트 에이전트는 네트워크 컨트롤러에서 할당 된 PA IP 주소를 수신 하 고 기본이 아닌 네트워크 구획에 2 개의 PA 호스트 vNICs를 만듭니다. 아래와 같이 PA IP 주소가 할당 된 각 호스트 vNICs에 네트워크 인터페이스가 할당 됩니다.  

-   Contoso Corp의 virtual machines VSID 및 PAs: **VSID** is 5001, **SQL PA** IS 192.168.1.10, **웹 PA** is 192.168.2.20  

-   Fabrikam Corp의 virtual machines VSID 및 PAs: **VSID** is 6001, **SQL PA** IS 192.168.1.10, **웹 PA** is 192.168.2.20  

네트워크 컨트롤러는 모든 네트워크 정책 (CA PA 매핑 포함)을 SDN 호스트 에이전트로 될 때마다 트리거되 하 여 영구 저장소 (OVSDB 데이터베이스 테이블)에 정책을 유지 합니다.  

Hyper-v 호스트 2의 Contoso Corp 웹 가상 컴퓨터 (10.1.1.12)가 10.1.1.11의 SQL Server에 대 한 TCP 연결을 만들면 다음과 같은 상황이 발생 합니다.  

-   10.1.1.11의 대상 MAC 주소에 대 한 VM ARPs  

-   VSwitch의 VFP 확장은이 패킷을 가로채서 SDN 호스트 에이전트로 보냅니다.  

-   SDN 호스트 에이전트는 10.1.1.11의 MAC 주소에 대 한 해당 정책 저장소를 찾습니다.  

-   MAC이 있으면 호스트 에이전트가 ARP 응답을 다시 VM에 삽입 합니다.  

-   MAC을 찾을 수 없으면 응답이 전송 되지 않고 10.1.1.11에 대 한 VM의 ARP 항목에 연결할 수 없음으로 표시 됩니다.  

-   이제 VM은 올바른 CA 이더넷 및 IP 헤더를 사용 하 여 TCP 패킷을 생성 하 고 vSwitch로 보냅니다.  

-   VSwitch의 VFP 전달 확장은 패킷이 수신 된 원본 vSwitch 포트에 할당 된 VFP 계층 (아래 설명 참조)을 통해이 패킷을 처리 하 고 VFP 통합 흐름 테이블에 새 흐름 항목을 만듭니다.  

-   VFP 엔진은 IP 및 이더넷 헤더를 기반으로 각 계층 (예: 가상 네트워크 계층)에 대 한 규칙 일치 또는 흐름 테이블 조회를 수행 합니다.  

-   가상 네트워크 계층의 일치 하는 규칙은 CA PA 매핑 공간을 참조 하 고 캡슐화를 수행 합니다.  

-   캡슐화 유형 (VXLAN 또는 NVGRE)은 VNet 계층에서 VSID와 함께 지정 됩니다.  

-   VXLAN 캡슐화의 경우 외부 UDP 헤더는 VSID 5001의 VXLAN 헤더에 생성 됩니다.  
    외부 IP 헤더는 SDN 호스트 에이전트의 정책 저장소를 기반으로 하 여 각각 Hyper-v 호스트 2 (192.168.2.20) 및 Hyper-v 호스트 1 (192.168.1.10)에 할당 된 원본 및 대상 PA 주소를 사용 하 여 생성 됩니다.  

-   그러면이 패킷이 VFP의 PA 라우팅 계층으로 흐릅니다.  

-   VFP의 PA 라우팅 계층은 PA 공간 트래픽과 VLAN ID에 사용 되는 네트워크 구획을 참조 하 고 호스트의 TCP/IP 스택을 사용 하 여 PA 패킷을 Hyper-v 호스트 1로 올바르게 전달 합니다.  

-   캡슐화 된 패킷이 수신 되 면 Hyper-v 호스트 1은 PA 네트워크 구획에서 패킷을 받아서 vSwitch에 전달 합니다.  

-   VFP는 VFP 계층을 통해 패킷을 처리 하 고 VFP 통합 흐름 테이블에 새 흐름 항목을 만듭니다.  

-   VFP 엔진은 가상 네트워크 계층의 ingres 규칙과 일치 하며 외부 캡슐화 된 패킷의 이더넷, IP 및 VXLAN 헤더를 제거 합니다.  

-   그런 다음 VFP 엔진은 대상 VM이 연결 된 vSwitch 포트로 패킷을 전달 합니다.  

Fabrikam Corp **Web** 가상 컴퓨터와 **SQL** 가상 컴퓨터 간의 트래픽에 대한 유사한 프로세스에서는 Fabrikam Corp에 대한 HNV 정책 설정을 사용합니다. 따라서 HNV를 통해 Fabrikam Corp 가상 컴퓨터와 Contoso Corp 가상 컴퓨터는 원래 인트라넷에 있는 것처럼 상호 작용합니다. Fabrikam Corp 가상 컴퓨터와 Contoso Corp 가상 컴퓨터는 동일한 IP 주소를 사용하고 있더라도 서로 상호 작용할 수 없습니다.  

별도의 주소 (Ca 및 PAs), Hyper-v 호스트의 정책 설정 및 인바운드 및 아웃 바운드 가상 컴퓨터 트래픽에 대 한 CA와 PA 간의 주소 변환은 NVGRE 키 또는 VLXAN VNID를 사용 하 여 이러한 서버 집합을 격리 합니다. 또한 가상화 매핑과 변환에서는 실제 네트워크 인프라에서 가상 네트워크 아키텍처를 분리합니다. Contoso **SQL** 및 **Web** 과 Fabrikam **SQL** 및 **Web** 이 고유 CA IP 서브넷(10.1.1/24)에 상주하더라도 실제 배포는 각각 서로 다른 PA 서브넷의 두 호스트 192.168.1/24 및 192.168.2/24에서 수행됩니다. 여기에 함축된 의미는 HNV를 통해 서브넷 간 가상 컴퓨터 프로비저닝 및 실시간 마이그레이션이 가능하다는 것입니다.  

## <a name="hyper-v-network-virtualization-architecture"></a>Hyper-V 네트워크 가상화 아키텍처  
Windows Server 2016에서 HNVv2는 Hyper-v 스위치 내의 NDIS 필터링 확장인 VFP (Azure 가상 필터링 플랫폼)를 사용 하 여 구현 됩니다. VFP의 주요 개념은 네트워크 정책을 프로그래밍 하기 위해 SDN 호스트 에이전트에 노출 되는 내부 API가 있는 일치 동작 흐름 엔진의 핵심 개념입니다. SDN 호스트 에이전트 자체는 OVSDB 및 WCF SouthBound 통신 채널을 통해 네트워크 컨트롤러에서 네트워크 정책을 받습니다. VFP를 사용 하 여 프로그래밍 한 가상 네트워크 정책 (예: CA PA 매핑) 뿐만 아니라 Acl, QoS 등의 추가 정책이 있습니다.  

VSwitch 및 VFP 전달 확장에 대 한 개체 계층 구조는 다음과 같습니다.  

-   vSwitch  

    -   외부 NIC 관리  

    -   NIC 하드웨어 오프 로드  

    -   전역 전달 규칙  

    -   포트  

        -   머리카락을 위한 송신 전달 계층-고정  

        -   매핑 및 NAT 풀에 대 한 공간 목록  

        -   통합 흐름 테이블  

        -   VFP 계층  

            -   흐름 테이블  

            -   그룹  

            -   규칙  

                -   규칙은 공백을 참조할 수 있습니다.  

VFP에서 계층은 정책 유형 (예: Virtual Network)에 따라 만들어지며 규칙/흐름 테이블의 제네릭 집합입니다. 이러한 기능을 구현 하기 위해 특정 규칙이 해당 계층에 할당 될 때까지 내장 기능을 사용할 수 없습니다. 각 계층에는 우선 순위가 할당 되며 계층은 우선 순위가 오름차순으로 할당 됩니다. 규칙은 주로 방향 및 IP 주소 제품군을 기반으로 하는 그룹으로 구성 됩니다. 그룹에도 우선 순위가 할당 되 고, 그룹에서 하나의 규칙이 지정 된 흐름과 일치할 수 있습니다.  

VFP 확장을 사용 하는 vSwitch의 전달 논리는 다음과 같습니다.  

-   수신 처리 (포트로 들어오는 패킷의 관점에서 수신)  

-   전송  

-   송신 처리 (포트를 나가는 패킷의 관점에서 송신)  

VFP는 NVGRE 및 VXLAN 캡슐화 유형 뿐만 아니라 외부 MAC VLAN 기반 전달에 대해 내부 MAC 전달을 지원 합니다.  

VFP 확장에는 패킷 트래버스를 위한 속도 및 빠른 경로가 있습니다. 흐름의 첫 번째 패킷은 각 계층의 모든 규칙 그룹을 트래버스 하 고 비용이 많이 드는 작업 인 규칙 조회를 수행 해야 합니다. 그러나 전달 된 규칙을 기반으로 하는 작업 목록과 함께 흐름이 통합 흐름 테이블에 등록 되 면 모든 후속 패킷이 통합 흐름 테이블 항목을 기반으로 처리 됩니다.  

HNV 정책은 호스트 에이전트에서 프로그래밍 합니다. 각 가상 컴퓨터 네트워크 어댑터는 IPv4 주소를 사용 하 여 구성 됩니다. 이는 가상 컴퓨터가 서로 통신하는 데 사용되는 CA이며, 가상 컴퓨터에서 IP 패킷으로 전달됩니다. HNV는 호스트 에이전트의 데이터베이스에 저장 된 네트워크 가상화 정책을 기반으로 PA 프레임의 CA 프레임을 캡슐화 합니다.  

![HNV 아키텍처](../../../media/hyper-v-network-virtualization-technical-details-in-windows-server/VNetF7.png)  

그림 9: HNV 아키텍처  

## <a name="summary"></a>요약  
클라우드 기반 데이터 센터는 향상된 확장성 및 보다 우수한 리소스 사용률과 같은 여러 이점을 제공할 수 있습니다. 이러한 잠재적 이점을 실현하려면 기본적으로 동적 환경에서 다중 테넌트 확장성 문제를 해결하는 기술이 필요합니다. HNV는 실제 네트워크 토폴로지에 대해 가상 네트워크 토폴로지를 분리하여 이러한 문제를 해결하고 데이터 센터의 운영 효율성을 개선하도록 설계되었습니다. 기존 표준을 기반으로 구축 된 HNV는 오늘날의 데이터 센터에서 실행 되 고 기존 VXLAN 인프라와 함께 작동 합니다. 이제 HNV를 사용 하는 고객은 데이터 센터를 사설 클라우드로 통합 하거나 하이브리드 클라우드를 사용 하 여 호스팅 서버 공급자의 환경으로 데이터 센터를 원활 하 게 확장할 수 있습니다.  

## <a name="see-also"></a><a name="BKMK_LINKS"></a>참고 항목  
HNVv2에 대 한 자세한 내용은 다음 링크를 참조 하세요.  


|       콘텐츠 유형       |                                                                                                                                              참조                                                                                                                                              |
|--------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **커뮤니티 리소스**  |                                                                -   [사설 클라우드 아키텍처 블로그](https://blogs.technet.com/b/privatecloud)<br />-질문 하기: [cloudnetfb@microsoft.com](mailto:%20cloudnetfb@microsoft.com)                                                                |
|         **RFC**          |                                                                   -   [NVGRE 초안 RFC](https://www.ietf.org/id/draft-sridharan-virtualization-nvgre-07.txt)<br />-   [VXLAN-RFC 7348](https://www.rfc-editor.org/info/rfc7348)                                                                    |
| **관련 기술** | -Windows Server 2012 r 2의 Hyper-v 네트워크 가상화 기술 세부 정보는 [Hyper-v 네트워크 가상화 기술 세부 정보](https://technet.microsoft.com/library/jj134174.aspx) 를 참조 하세요.<br />[네트워크 컨트롤러](../../../sdn/technologies/network-controller/Network-Controller.md) -    |

